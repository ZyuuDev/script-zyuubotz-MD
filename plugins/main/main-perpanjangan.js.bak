import moment from "moment-timezone"
import fs from "fs"
let handler = async (m, { senderKey, conn, usedPrefix, command, text, isPrems }) => {
    try {
        await conn.loading(m, conn)
        let [type, hari, deposit] = text.split("|")
        let user = global.db.data.users[senderKey]
        let chat = global.db.data.chats[m.chat]
        let name = user.registered ? user.name : await conn.getName(senderKey)
        let groupName = await conn.getName(m.chat)
        if (/sewa/i.test(type)) {
            if (!m.isGroup) return global.dfail("group", m, conn)
            if (hari && deposit) {
                hari = Number(hari)
                let harga = Number(deposit)
                let refID = generateRefID()
        
                if (user.deposit < harga) return m.reply(`Saldo Deposit kamu tidak mencukupi untuk membeli ini! \nSilahkan deposit dahulu menggunakan command *${usedPrefix}deposit*`)
                let caption = await getCaption("Sukses", refID, `Perpanjangan Group ${groupName} ${hari} Hari`, harga, "")
                let image = await imageTransaksi("Sukses")
                await conn.adReply(m.chat, caption, `Halo ${name}, ${wish()}`, global.config.watermark, image, global.config.website, m)
                let jumlahHari = 86400000 * hari
                let now = Date.now()
                chat.expired = now < chat.expired ? chat.expired + jumlahHari : now + jumlahHari
                let timers = chat.expired - now
                await conn.reply(global.config.owner[0][0] + "@s.whatsapp.net", `
âœ”ï¸ Success Perpanjangan Group ${groupName}
ğŸ“› *Name:* ${name}
ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ *Group:* ${groupName}
ğŸ“† *Days:* ${hari} days
ğŸ“‰ *Countdown:* ${msToTime(timers)}
`.trim())
                user.deposit -= harga
                user.historyTrx.push({ status: true, trxId: refID, nominal: harga, type: `Perpanjangan Group ${groupName} ${hari} Hari`, time: Date.now() })
            } else if (hari && !deposit) {
                hari = hari.match(/\d+/g).join('')
                if (!/10|20|30|40|50|60|70|80|90|100/i.test(hari)) return m.reply(`Kamu ingin perpanjang group berapa hari? \n\nContoh: \n${usedPrefix + command} 10`)
                let harga = calculateValueSewa(hari)
                let head = `Nama Group : ${groupName}\nExpired : \n${msToDate(chat.expired - Date.now())}`
                await conn.textList(m.chat, `${head} \n\nSilahkan Pilih Metode Pembayaran Kamu!`, false, [
                    [`${usedPrefix}pembayaran ppj${hari}|${m.chat}|${harga}|Perpanjangan Group ${groupName} ${hari} Hari|qris`, "1", "QRIS"],
                    [`${usedPrefix + command} sewa|${hari}|${harga}`, "2", "Deposit"]
                ], m)
            } else {
                let caption = `
â *_Harga Perpanjangan_*
âƒ _10 Hari 4,5k / Group_
âƒ _20 Hari 9k / Group_
âƒ _30 Hari 13,5k / Group_
âƒ _40 Hari 18k / Group_
    
â *_Fitur_*
âƒ _Antilink_
âƒ _Welcome_
âƒ _Enable_
âƒ _Store List_
âƒ _Promote/Demote_
âƒ _HideTag_
âƒ _Dan Lain Lain_
`.trim()
                let list = [
                    [".perpanjangan sewa|10", "1", "Perpanjangan Sewa 10 Hari"],
                    [".perpanjangan sewa|20", "2", "Perpanjangan Sewa 20 Hari"],
                    [".perpanjangan sewa|30", "3", "Perpanjangan Sewa 30 Hari"],
                    [".perpanjangan sewa|40", "4", "Perpanjangan Sewa 40 Hari"]
                ]
                await conn.textList(m.chat, caption, fs.readFileSync("./media/thumbnail.jpg"), list, m)
                //await conn.adReply(m.chat, caption, `Halo ${name}, ${wish()}`, global.config.watermark, fs.readFileSync("./media/thumbnail.jpg"), global.config.website, m)
            }
        } else if (/premium/i.test(type)) {
            if (!isPrems) return m.reply(`Kamu belum memiliki premium! silahkan beli premium terlebih dahulu dengan mengetik *${usedPrefix}premium*`)
            if (hari && deposit) {
                hari = Number(hari)
                let harga = Number(deposit)
                let refID = generateRefID()
        
                if (user.deposit < harga) return m.reply(`Saldo Deposit kamu tidak mencukupi untuk membeli ini! \nSilahkan deposit dahulu menggunakan command *${usedPrefix}deposit*`)
                let caption = await getCaption("Sukses", refID, `Premium ${hari} Hari`, harga, "")
                let image = await imageTransaksi("Sukses")
                await conn.adReply(m.chat, caption, `Halo ${name}, ${wish()}`, global.config.watermark, image, global.config.website, m)
                let jumlahHari = 86400000 * hari
                let now = Date.now()
                user.premiumTime = now < user.premiumTime ? user.premiumTime + jumlahHari : now + jumlahHari
                user.premium = true
                let timers = user.premiumTime - now
                await conn.reply(global.config.owner[0][0] + "@s.whatsapp.net", `
âœ”ï¸ Success
ğŸ“› *Name:* ${name}
ğŸ“† *Days:* ${hari} days
ğŸ“‰ *Countdown:* ${msToTime(timers)}
`.trim())
                user.deposit -= harga
                user.historyTrx.push({ status: true, trxId: refID, nominal: harga, type: `Perpanjangan Premium ${hari} Hari`, time: Date.now() })
            } else if (hari && !deposit ){
                hari = hari.match(/\d+/g).join('')
                if (!/10|20|30|40|50|60|70|80|90|100/i.test(hari)) return m.reply(`Kamu ingin perpanjang premium berapa hari? \n\nContoh: \n${usedPrefix + command} 15`)
                let harga = calculateValuePremium(hari)
                let head = `Nomor : ${senderKey.split("@")[0]}`
                await conn.textList(m.chat, `${head} \n\nSilahkan Pilih Metode Pembayaran Kamu!`, false, [
                    [`${usedPrefix}pembayaran prem${hari}|${senderKey.split("@")[0]}|${harga}|Perpanjangan Premium ${hari} Hari|qris`, "1", "QRIS"],
                    [`${usedPrefix + command} premium|${hari}|${harga}`, "2", "Deposit"]
                ], m)
            } else {
                let caption = `
â *_Harga Premium_*
âƒ _10 Hari / 4,5k_
âƒ _20 Hari / 9k_
âƒ _30 Hari / 13,5k_
âƒ _40 Hari / 18k_
        
â *_Fitur_*
âƒ _Unlimited Limit_
âƒ _Nsfw_
âƒ _Bebas Pakai Bot Di Pc_
âƒ _Dan Lain Lain_
`.trim()
                let list = [
                    [".perpanjangan premium|10", "1", "Perpanjangan Premium 10 Hari"],
                    [".perpanjangan premium|20", "2", "Perpanjangan Premium 20 Hari"],
                    [".perpanjangan premium|30", "3", "Perpanjangan Premium 30 Hari"],
                    [".perpanjangan premium|40", "4", "Perpanjangan Premium 40 Hari"]
                ]
                await conn.textList(m.chat, caption, fs.readFileSync("./media/thumbnail.jpg"), list, m)
                //await conn.adReply(m.chat, caption, `Halo ${name}, ${wish()}`, global.config.watermark, fs.readFileSync("./media/thumbnail.jpg"), global.config.website, m)
            }
        } else {
            await conn.textOptions(m.chat, "Kamu ingin perpanjang apa?", false, [[".perpanjangan premium", "Premium"], [".perpanjangan sewa", "Sewa"]], m)
        }
    } finally {
        await conn.loading(m, conn, true)
    }
}
handler.help = ["perpanjangan"]
handler.tags = ["main"]
handler.command = /^(perpanjang(an)?)$/i
export default handler

function calculateValueSewa(days) {
    const valuePer15Days = 4500
    const valuePerDay = valuePer15Days / 10
    const totalValue = days * valuePerDay
    return parseInt(totalValue)
}

function calculateValuePremium(days) {
    const valuePer15Days = 4500
    const valuePerDay = valuePer15Days / 10
    const totalValue = days * valuePerDay
    return parseInt(totalValue)
}

function toRupiah(number) {
    return new Intl.NumberFormat('id-ID').format(number)
}

function imageTransaksi(status) {
    let image = {
        "Pending": "pembayaran_diproses.png",
        "Sukses": "pembayaran_berhasil.png",
        "Gagal": "pembayaran_gagal.png"
    }
    return fs.readFileSync(`./media/${image[status]}`)
}

function generateRefID() {
    return 'ry-' + Math.random().toString(36).substr(2, 9)
}

function getCaption(status, refID, produk, harga, sn) {
    let desc = {
        "Pending": "",
        "Sukses": "_Silahkan Cek Akun Anda, Jika Belum Masuk Hubungi Owner._",
        "Gagal": "_Mohon Maaf, Saldo Anda Sudah Di-Convert Menjadi Saldo Deposit, Silahkan Ulangi Transaksi Atau Hubungi Owner._"
    }
    let caption = `
*TRANSAKSI ${status.toUpperCase()}!*

RefID : ${refID} ${sn ? `
SN : ${sn}` : ""}
Pembelian : ${produk}
Harga : Rp ${toRupiah(harga)} ${status == "Gagal" ? `
Saldo : + Rp ${toRupiah(harga)}` : ""}
Status : ${status}
Waktu : ${formattedDate(Date.now())}

_Pembelian ${produk} ${status}!_ ${desc[status]}
`.trim()
    return caption
}

function wish() {
    let wishloc = ''
    let time = moment.tz('Asia/Jakarta').format('HH')
    wishloc = ('Hi')
    if (time >= 0) {
        wishloc = ('Selamat Malam')
    }
    if (time >= 4) {
        wishloc = ('Selamat Pagi')
    }
    if (time >= 11) {
        wishloc = ('Selamat Siang')
    }
    if (time >= 15) {
        wishloc = ('ï¸Selamat Sore')
    }
    if (time >= 18) {
        wishloc = ('Selamat Malam')
    }
    if (time >= 23) {
        wishloc = ('Selamat Malam')
    }
    return wishloc
}

function msToDate(ms) {
    let days = Math.floor(ms / (24 * 60 * 60 * 1000))
    let daysms = ms % (24 * 60 * 60 * 1000)
    let hours = Math.floor((daysms) / (60 * 60 * 1000))
    let hoursms = ms % (60 * 60 * 1000)
    let minutes = Math.floor((hoursms) / (60 * 1000))
    return days + " Days â˜€ï¸\n" + hours + " Hours ğŸ•\n" + minutes + " Minute â°"
}

function formattedDate(ms) {
    return moment(ms).tz('Asia/Jakarta').format('YYYY-MM-DD HH:mm')
}

function msToTime(ms) {
    let seconds = parseInt((ms / 1000) % 60)
    let minutes = parseInt((ms / (1000 * 60)) % 60)
    let hours = parseInt((ms / (1000 * 60 * 60)) % 24)
    let days = parseInt(ms / (1000 * 60 * 60 * 24))

    return `${days}d ${hours}h ${minutes}m ${seconds}s`
}